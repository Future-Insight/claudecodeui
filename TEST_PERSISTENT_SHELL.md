# 持久化Shell会话测试指南 (项目级管理)

## 新功能概述

我们已经实现了不依赖tmux的持久化shell会话管理，具备以下特性：

### 🎯 核心功能
1. **服务端持久化**：shell进程在服务端持续运行，不因客户端断开而终止
2. **智能重连**：客户端重新连接时自动恢复到同一shell会话
3. **输出缓冲**：断开期间的输出被缓存，重连时会回放最近的内容
4. **项目级会话管理**：每个项目维护一个独立的shell会话，简化管理逻辑
5. **状态监控**：实时显示shell会话状态和连接状态

### 🔧 技术实现
- **ShellSessionManager**: 服务端shell进程池管理器
- **项目级存储**: 每个项目维护一个独立的node-pty进程
- **智能缓冲**: 保留最近1000条输出，重连时回放最近30秒或50条
- **自动清理**: 2小时无活动的会话会被自动清理

### 🆕 简化的管理模式
- **一个项目一个Shell**：不再按sessionId区分，每个项目只有一个持久shell
- **更简单的API**：使用项目名称而不是sessionId作为主要标识符
- **统一体验**：同一个项目内的不同Claude会话共享同一个shell环境

## 测试步骤

### 测试1：基本持久化功能
1. 启动应用并连接到shell
2. 在shell中执行一些命令（如创建文件、查看目录等）
3. 关闭浏览器标签页或刷新页面
4. 重新打开应用并连接shell
5. **预期结果**: 应该看到"Reconnected to existing Claude session"消息，并完整显示之前的1000条输出历史

### 测试2：多项目隔离
1. 在项目A中创建一个shell会话，执行一些命令
2. 切换到项目B，连接shell并执行不同的命令
3. 再切换回项目A
4. **预期结果**: 每个项目的shell会话应该是独立的，互不影响

### 测试3：同项目内Session切换
1. 在项目A中连接shell，执行一些命令
2. 在同一项目内切换到不同的Claude会话
3. 重新连接shell
4. **预期结果**: 应该连接到同一个shell进程，能看到之前的命令历史

### 测试4：长时间运行
1. 在shell中启动一个长时间运行的命令（如监控、构建等）
2. 断开客户端连接
3. 等待几分钟后重新连接
4. **预期结果**: 长时间运行的命令应该仍在执行，输出应该继续显示

### 测试5：完整输出缓冲和回放
1. 连接到shell并执行很多命令（超过50条，测试完整缓冲）
2. 断开连接
3. 等待一段时间（让后台可能产生更多输出）
4. 重新连接
5. **预期结果**: 应该看到"--- Restoring previous output (N entries) ---"分隔符和完整的缓冲区内容（最多1000条）

### 测试6：会话ID显示和状态
1. 用特定sessionId连接shell（如通过Claude会话）
2. 观察UI状态显示，应该显示"Connected (xxxxxxxx...)"，其中xxxxxxxx是sessionId的前8位
3. 断开连接后检查状态变化
4. 重连后再次检查状态
5. **预期结果**: 
   - 连接时：绿色"Connected (sessionId前8位...)" + 紫色"Shell Active"
   - 断开时：红色"Disconnected" + 紫色"Shell Active (Background)"
   - 重连时：显示相同的sessionId，不会改变

### 测试7：远程Shell终止
1. 建立shell连接
2. 使用"终止远程Shell"按钮终止会话
3. 尝试重新连接
4. **预期结果**: 会话被完全终止，重连时会创建新的会话

## 与tmux对比

| 功能 | Tmux方案 | 新的持久化方案 |
|------|---------|---------------|
| 服务端持久化 | ✅ | ✅ |
| 客户端重连 | ✅ | ✅ |
| 滚动历史查看 | ❌ 需要Ctrl+b[ | ✅ 原生滚轮支持 |
| 输出缓冲 | ❌ | ✅ 完整1000条历史缓冲 |
| 会话ID显示 | ❌ | ✅ 显示重连会话ID |
| 学习成本 | ❌ 需要学习tmux快捷键 | ✅ 无额外学习成本 |
| 状态监控 | ⚠️ 基础状态显示 | ✅ 详细状态信息 |
| 多项目管理 | ✅ | ✅ 简化的项目级管理 |

## 预期用户体验改进

1. **完整历史恢复**: 用户断开重连后能看到完整的1000条输出历史，不错过任何内容
2. **原生滚动**: 可以直接用鼠标滚轮查看历史输出
3. **会话追踪**: 显示重连的会话ID，帮助用户确认连接到正确的会话
4. **智能提示**: UI会显示是否有后台shell会话正在运行
5. **简单操作**: 不需要学习任何复杂的快捷键组合
6. **明确控制**: "终止远程Shell"按钮清晰表达操作意图

## 故障排除

如果遇到问题：
1. 检查服务端日志中的shell管理器输出
2. 使用`/api/shell-sessions`端点查看所有活跃会话
3. 检查浏览器控制台的连接状态日志
4. 确认WebSocket连接正常建立

这个新方案提供了与tmux相同的核心功能（服务端持久化），同时提供了更好的用户体验和更直观的操作方式。