# Claude Code UI 技术架构文档

## 项目概述

Claude Code UI 是一个为 Claude Code CLI 和 Cursor CLI 提供 Web 界面的应用程序。它提供了桌面和移动端响应式设计，支持会话管理、文件浏览、Git 操作等功能。

## 核心技术栈

### 前端
- **React 18** - 主要 UI 框架
- **Vite** - 构建工具和开发服务器
- **TailwindCSS** - 样式框架
- **React Router DOM** - 路由管理
- **CodeMirror 6** - 代码编辑器
- **XTerm.js** - 终端模拟器
- **WebSocket** - 实时通信

### 后端
- **Node.js** - 服务器运行时
- **Express.js** - Web 框架
- **WebSocket (ws)** - 实时通信
- **SQLite3** - 数据库
- **Better-SQLite3** - SQLite 驱动
- **node-pty** - 伪终端接口
- **Chokidar** - 文件系统监控

## 数据存储详解

### 1. auth.db - 用户认证数据库
位置：`server/database/auth.db`

**用途：** 存储用户认证信息，支持单用户系统

**表结构：**
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_login DATETIME,
    is_active BOOLEAN DEFAULT 1
);
```

### 2. store.db 相关文件（Cursor 会话数据）
位置：`~/.cursor/chats/{cwdId}/{sessionId}/store.db`

**用途：** Cursor CLI 的会话数据存储
- `store.db-shm` - SQLite 共享内存文件
- `store.db-wal` - SQLite 预写式日志文件

**数据结构：**
- `meta` 表：存储会话元数据（标题、创建时间等）
- `blobs` 表：存储消息内容和会话数据

### 3. Claude 项目数据
位置：`~/.claude/projects/{projectName}/*.jsonl`

**用途：** Claude Code CLI 的会话记录，以 JSONL 格式存储

## 核心架构组件

### 1. 数据流架构

```
前端 React 组件
    ↓ (WebSocket)
后端 Express 服务器
    ↓ (spawn)
Claude CLI / Cursor CLI
    ↓ (文件系统)
SQLite / JSONL 数据
```

### 2. 会话管理系统

**会话保护机制：**
- 活跃会话期间暂停项目更新，防止界面刷新干扰用户
- 支持会话恢复和中断
- 处理临时会话 ID 和真实会话 ID

**关键文件：**
- `server/claude-cli.js` - Claude CLI 集成
- `server/cursor-cli.js` - Cursor CLI 集成
- `server/projects.js` - 项目和会话管理

### 3. 实时通信架构

**WebSocket 路由：**
- `/ws` - 聊天通信
- `/shell` - 终端通信

**消息类型：**
- `claude-command` - Claude 指令
- `cursor-command` - Cursor 指令
- `abort-session` - 中断会话
- `projects_updated` - 项目更新通知

### 4. 文件系统监控

使用 Chokidar 监控 `~/.claude/projects` 目录：
- 实时检测项目变化
- 防抖处理避免过度更新
- 忽略不必要的文件（node_modules, .git 等）

### 5. 项目管理系统

**项目发现机制：**
1. 扫描 `~/.claude/projects` 目录
2. 解析 JSONL 文件提取项目路径
3. 缓存项目目录映射
4. 支持手动添加项目

**项目配置：**
- 位置：`~/.claude/project-config.json`
- 功能：自定义项目显示名称、手动添加的项目

## 技术核心特性

### 1. 跨平台兼容性
- 支持 Windows, macOS, Linux
- 使用 `cross-spawn` 确保跨平台命令执行
- 平台特定的 shell 选择（PowerShell vs Bash）

### 2. 安全机制
- JWT 认证
- 密码哈希存储（bcrypt）
- 路径验证防止目录遍历
- API 密钥可选验证

### 3. 性能优化
- 文件树懒加载
- 会话分页加载
- 项目目录缓存
- 防抖处理文件变化

### 4. 多模型支持
- Claude Sonnet 4
- Opus 4.1
- GPT-5
- 通过 CLI 参数配置

## 数据流程详解

### 用户交互流程：
1. **用户登录** → JWT 认证 → 会话建立
2. **选择项目** → 读取项目配置 → 显示会话列表
3. **发送消息** → WebSocket → 后端路由 → CLI 进程
4. **CLI 响应** → 实时流式输出 → 前端显示
5. **会话保存** → JSONL/SQLite → 持久化存储

### 文件操作流程：
1. **文件浏览** → 递归读取目录 → 构建文件树
2. **文件编辑** → CodeMirror → 实时保存
3. **Git 操作** → 集成 Git 命令 → 状态更新

### 实时更新流程：
1. **文件变化** → Chokidar 监控 → 防抖处理
2. **项目更新** → 重新解析 → WebSocket 广播
3. **前端更新** → 会话保护检查 → 界面刷新

## 配置和部署

### 环境变量：
- `PORT` - 服务器端口（默认 3001）
- `API_KEY` - 可选的 API 访问密钥

### 启动模式：
- 开发模式：`npm run dev` - 并发运行前后端
- 生产模式：`npm start` - 构建后启动

### 数据持久化：
- 用户数据：`server/database/auth.db`
- 项目配置：`~/.claude/project-config.json`
- 会话数据：`~/.claude/projects/` 和 `~/.cursor/chats/`

## 关键创新点

1. **统一界面** - 同时支持 Claude Code 和 Cursor CLI
2. **会话保护** - 智能的实时更新控制
3. **移动适配** - 完整的响应式设计
4. **实时同步** - 文件系统监控和即时更新
5. **多会话管理** - 支持并发会话和历史恢复

这个架构设计确保了应用的高性能、可扩展性和用户体验，为开发者提供了强大而直观的 AI 编程助手界面。